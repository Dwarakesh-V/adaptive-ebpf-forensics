<!DOCTYPE html>
<html>

<head>
    <title>Investigator Console</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='common_style.css') }}">
</head>

<script>
    // If session expired, force login
    fetch("/dashboard", { method: "HEAD" })
        .catch(() => {
            window.location.href = "/";
        });
</script>

<body>

    <div class="container">
        <button class="logout" onclick="window.location.href='/logout'">Logout</button>
        <h2>Live Memory Forensics Console</h2>

        <div class="card">
            <button onclick="startStream()">Start Live Capture</button>
            <button class="secondary" onclick="clearConsole()">Clear View</button>
            <button class="secondary" onclick="filterSeverity('HIGH')">High Only</button>
            <button class="secondary" onclick="filterSeverity('ALL')">Show All</button>
        </div>

        <div class="card">
            <p style="color:#9ca3af;">
                Live memory events streamed from adaptive eBPF probes.
                Severity levels are dynamically assigned based on detected behavior.
            </p>

            <div id="console"
                style="height:300px; overflow-y:auto; font-family:monospace; background:#020617; padding:12px;">
            </div>
        </div>

        <div class="card">
            <form action="/generate-report" method="post">
                <button class="danger">Generate Encrypted Forensic Snapshot</button>
            </form>
            <p>{{ message }}</p>
        </div>
    </div>

    <script>
        let source;
        let currentFilter = "ALL";

        function startStream() {
            if (source) return;
            source = new EventSource("/live-stream");

            source.onmessage = function (event) {
                const data = JSON.parse(event.data);
                if (currentFilter !== "ALL" && data.severity !== currentFilter) return;

                const severityClass =
                    data.severity === "HIGH" ? "high" :
                        data.severity === "MEDIUM" ? "medium" : "low";

                const line = `
                <div>
                    [${data.time}] PID ${data.pid} (${data.process})
                    <span class="badge ${severityClass}">
                        ${data.severity}
                    </span>
                    â†’ ${data.event}
                </div>
            `;

                const consoleDiv = document.getElementById("console");
                consoleDiv.innerHTML += line;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            };
        }

        function clearConsole() {
            document.getElementById("console").innerHTML = "";
        }

        function filterSeverity(level) {
            currentFilter = level;
        }
    </script>

    <script>
        // Prevent browser back/forward navigation
        if (window.history && window.history.pushState) {
            window.history.pushState(null, "", window.location.href);
            window.onpopstate = function () {
                window.location.href = "/";
            };
        }
    </script>

</body>

</html>